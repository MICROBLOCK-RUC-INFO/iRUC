ç°åœ¨æœ‰ä¸€ä¸ªapolloçš„è”åˆç½‘å…³é¡¹ç›®
-----------------------------------------
å…¶gateway-serviceçš„index.jså†…å®¹å¦‚ä¸‹ï¼š

const { ApolloServer } = require('@apollo/server');
const { ApolloGateway } = require('@apollo/gateway');

const express = require('express');
const { expressMiddleware } = require('@apollo/server/express4');

const gateway = new ApolloGateway({
  serviceList: [
    { name: 'account-service', url: 'http://localhost:4001/graphql' },
  ],
});

const server = new ApolloServer({
  gateway,
  subscriptions: false,
  introspection: true,
});

async function startServer() {
  // å¯åŠ¨ Apollo Server
  await server.start();

  // åˆ›å»º Express åº”ç”¨
  const app = express();
  app.use(express.json());

  // å°† Apollo Server ä¸­é—´ä»¶æ·»åŠ åˆ° Express åº”ç”¨
  app.use('/graphql', expressMiddleware(server));

  // å¯åŠ¨ HTTP æœåŠ¡å™¨
  app.listen(4000, () => {
    console.log(`ğŸš€ Gateway ready at http://localhost:4000/graphql`);
  });
}

// å¯åŠ¨æœåŠ¡
startServer();
--------------------------------------
å…¶æŸä¸ªå…·ä½“æ•°æ®åº“serviceå†…å®¹å¦‚ä¸‹ï¼š
graphql-account-serviceï¼š
db.jså†…å®¹å¦‚ä¸‹ï¼š
const { Sequelize, DataTypes } = require('sequelize');

// åˆ›å»ºä¸PostgreSQLæ•°æ®åº“çš„è¿æ¥
const sequelize = new Sequelize('postgres://admin:12345678@localhost:5432/account_db', {
  dialect: 'postgres',
});

// å®šä¹‰Accountæ¨¡å‹ï¼Œæ˜ å°„åˆ°æ•°æ®åº“ä¸­çš„accountsè¡¨
const Account = sequelize.define('Account', {
  id: {
    type: DataTypes.BIGINT,
    primaryKey: true,
    autoIncrement: true,
  },
  name: {
    type: DataTypes.STRING,
    allowNull: false,
    unique: true,
  },
  lastSeen: {
    type: DataTypes.DATE,
  },
  incomes: {
    type: DataTypes.ARRAY(DataTypes.STRING),
  },
  expenses: {
    type: DataTypes.ARRAY(DataTypes.STRING),
  },
  saving: {
    type: DataTypes.STRING,
    allowNull: false,
  },
});

module.exports = { sequelize, Account };

index.jså†…å®¹å¦‚ä¸‹ï¼š
const { ApolloServer } = require('@apollo/server'); // Apollo Server 4.x
const { buildSubgraphSchema } = require('@apollo/subgraph'); // Federationæ”¯æŒ
const express = require('express'); // ä½¿ç”¨ Express å¤„ç† HTTP è¯·æ±‚
const { expressMiddleware } = require('@apollo/server/express4'); // Apollo Server å’Œ Express é›†æˆ
const { typeDefs, resolvers } = require('./schema'); // å¼•å…¥ schema å’Œ resolvers
const { sequelize } = require('./db'); // æ•°æ®åº“è¿æ¥
const bodyParser = require('body-parser');

// åˆ›å»º Apollo Server å®ä¾‹ï¼Œä½¿ç”¨ Federation æ”¯æŒ
const server = new ApolloServer({
  schema: buildSubgraphSchema({
    typeDefs,
    resolvers,
  }),
});

// åˆ›å»º Express åº”ç”¨
const app = express();

// å¯åŠ¨ Apollo Serverï¼Œå¹¶ä¸ Express é›†æˆ
async function startServer() {
  // å¯åŠ¨ Apollo Server
  await server.start();
  app.use(bodyParser.json({ limit: '10mb' }));

  // ä½¿ç”¨ Apollo ä¸­é—´ä»¶å¤„ç† /graphql è·¯ç”±
  app.use('/graphql', express.json(), expressMiddleware(server));

  // åŒæ­¥æ•°æ®åº“å¹¶å¯åŠ¨ Express æœåŠ¡å™¨
  sequelize.sync().then(() => {
    app.listen({ port: 4001 }, () => {
      console.log(`ğŸš€ Account Subgraph ready at http://localhost:4001/graphql`);
    });
  });
}

// å¯åŠ¨æœåŠ¡
startServer();

schema.jså†…å®¹å¦‚ä¸‹ï¼š
const { gql } = require('apollo-server');
const { Account } = require('./db');

// GraphQLç±»å‹å®šä¹‰
const typeDefs = gql`
  type Account {
    id: ID!
    name: String!
    lastSeen: String
    incomes: [String]
    expenses: [String]
    saving: String!
  }

  type Query {
    getAccountByName(name: String!): Account
  }

  input AccountInput {
    name: String!
    lastSeen: String
    incomes: [String]
    expenses: [String]
    saving: String!
  }

  type Mutation {
    updateAccount(account: AccountInput!): Account
  }
`;

// GraphQLè§£æå™¨å®šä¹‰
const resolvers = {
  Query: {
    async getAccountByName(_, { name }) {
      return await Account.findOne({ where: { name } });
    },
  },
  Mutation: {
    async updateAccount(_, { account }) {
      const [updatedAccount] = await Account.upsert(account);
      return updatedAccount;
    },
  },
};

module.exports = { typeDefs, resolvers };
----------------------------------------------------
ç°åœ¨ï¼Œæˆ‘æœ‰ä¸€ä¸ªæ–°çš„æ•°æ®åº“è¦åŠ å…¥è¿™ä¸ªè”åˆç½‘å…³

æ•°æ®åº“ç±»å‹ä¸ºpgæ•°æ®åº“ï¼Œæ•°æ®åº“åä¸ºstatistic_dbï¼Œè¡¨åä¸ºDataPointsï¼Œè¡¨çš„schemaå¦‚ä¸‹ï¼š
"column_name"	"data_type"	"is_nullable"	"column_default"
"statistics"	"jsonb"	"YES"	
"id"	"jsonb"	"NO"	
"rates"	"jsonb"	"YES"	
"incomes"	"ARRAY"	"YES"	
"expenses"	"ARRAY"	"YES"	
ä¸€ç»„ç¤ºä¾‹æ•°æ®ä¸ºï¼š
"id"	"incomes"	"expenses"	"statistics"	"rates"	"createdAt"	"updatedAt"
"{""date"": ""2024-10-23T12:00:00Z"", ""account"": ""Alice""}"	"{Salary:5000,Bonus:2000}"	"{Rent:1500,Groceries:500}"	"{""SAVING_AMOUNT"": 3000, ""INCOMES_AMOUNT"": 0, ""EXPENSES_AMOUNT"": 0}"	"{""EUR"": 0.85, ""RUB"": 75, ""USD"": 1, ""BASE"": 1}"	"2024-11-13 02:23:12.607+08"	"2024-12-09 12:46:43.944+08"

åœ¨javaç¨‹åºä¸­å¯¹è¯¥è¡¨çš„æŸ¥è¯¢æ–¹å¼ï¼š
ä¸€ä¸ªç”±accountæŸ¥datapointï¼šgetDataPointByAccount
ä¸€ä¸ªæ›´æ–°datapointï¼šupdateDataPoint
å…·ä½“ä»£ç ï¼š
@Override
    public DataPoint save(String accountName, Account account) {
        Instant today = LocalDate.now().atStartOfDay()
                .atZone(ZoneId.systemDefault()).toInstant();
        Date todayDate = Date.from(today);
        
        Optional<DataPoint> existingDataPoint = repository.findById(new DataPointId(accountName, todayDate));

        Instant instant = LocalDate.now().atStartOfDay()
                .atZone(ZoneId.systemDefault()).toInstant();

        DataPointId pointId = new DataPointId(accountName, Date.from(instant));

        Set<ItemMetric> incomes = account.getIncomes().stream()
                .map(this::createItemMetric)
                .collect(Collectors.toSet());

        Set<ItemMetric> expenses = account.getExpenses().stream()
                .map(this::createItemMetric)
                .collect(Collectors.toSet());

        DataPoint dataPoint = new DataPoint();
        dataPoint.setId(pointId);
        dataPoint.setIncomes(incomes);
        dataPoint.setExpenses(expenses);

        log.debug("New datapoint created: {}", pointId);

        return repository.save(dataPoint);
    }
-------------------------------
ç»™å‡ºæ–°å¢çš„é¡¹ç›®ç»“æ„ã€æ‰€æœ‰æ–‡ä»¶çš„å®Œæ•´ä»£ç ã€‚åœ¨ä¸€ä¸ªå›å¤ä¸­ç»™å‡ºï¼Œç”¨ä¸­æ–‡å›ç­”ã€‚