æ ¹æ®æ‚¨çš„éœ€æ±‚ï¼Œæˆ‘å°†ä¸ºæ‚¨åˆ›å»ºä¸€ä¸ªæ–°çš„GraphQLå­å›¾æœåŠ¡æ¥å¤„ç†ç»Ÿè®¡æ•°æ®åº“ã€‚ä»¥ä¸‹æ˜¯å®Œæ•´çš„é¡¹ç›®ç»“æ„å’Œä»£ç ï¼š

## é¡¹ç›®ç»“æ„
```
graphql-statistic-service/
â”œâ”€â”€ package.json
â”œâ”€â”€ index.js
â”œâ”€â”€ db.js
â””â”€â”€ schema.js
```

## å®Œæ•´ä»£ç 

### 1. package.json
```json
{
  "name": "graphql-statistic-service",
  "version": "1.0.0",
  "description": "GraphQL Statistic Service for Apollo Federation",
  "main": "index.js",
  "scripts": {
    "start": "node index.js",
    "dev": "nodemon index.js"
  },
  "dependencies": {
    "@apollo/server": "^4.0.0",
    "@apollo/subgraph": "^2.0.0",
    "apollo-server": "^3.0.0",
    "express": "^4.18.0",
    "sequelize": "^6.28.0",
    "pg": "^8.8.0",
    "pg-hstore": "^2.3.4",
    "body-parser": "^1.20.0"
  },
  "devDependencies": {
    "nodemon": "^2.0.20"
  }
}
```

### 2. db.js
```javascript
const { Sequelize, DataTypes } = require('sequelize');

// åˆ›å»ºä¸PostgreSQLæ•°æ®åº“çš„è¿æ¥
const sequelize = new Sequelize('postgres://admin:12345678@localhost:5432/statistic_db', {
  dialect: 'postgres',
});

// å®šä¹‰DataPointæ¨¡å‹ï¼Œæ˜ å°„åˆ°æ•°æ®åº“ä¸­çš„DataPointsè¡¨
const DataPoint = sequelize.define('DataPoint', {
  id: {
    type: DataTypes.JSONB,
    primaryKey: true,
    allowNull: false,
  },
  incomes: {
    type: DataTypes.ARRAY(DataTypes.STRING),
    allowNull: true,
  },
  expenses: {
    type: DataTypes.ARRAY(DataTypes.STRING),
    allowNull: true,
  },
  statistics: {
    type: DataTypes.JSONB,
    allowNull: true,
  },
  rates: {
    type: DataTypes.JSONB,
    allowNull: true,
  },
}, {
  tableName: 'DataPoints',
  timestamps: true, // è‡ªåŠ¨æ·»åŠ createdAtå’ŒupdatedAtå­—æ®µ
});

module.exports = { sequelize, DataPoint };
```

### 3. schema.js
```javascript
const { gql } = require('apollo-server');
const { DataPoint } = require('./db');

// GraphQLç±»å‹å®šä¹‰
const typeDefs = gql`
  type DataPointId {
    date: String!
    account: String!
  }

  type Statistics {
    SAVING_AMOUNT: Float
    INCOMES_AMOUNT: Float
    EXPENSES_AMOUNT: Float
  }

  type Rates {
    EUR: Float
    RUB: Float
    USD: Float
    BASE: Float
  }

  type DataPoint {
    id: DataPointId!
    incomes: [String]
    expenses: [String]
    statistics: Statistics
    rates: Rates
    createdAt: String
    updatedAt: String
  }

  input DataPointIdInput {
    date: String!
    account: String!
  }

  input StatisticsInput {
    SAVING_AMOUNT: Float
    INCOMES_AMOUNT: Float
    EXPENSES_AMOUNT: Float
  }

  input RatesInput {
    EUR: Float
    RUB: Float
    USD: Float
    BASE: Float
  }

  input DataPointInput {
    id: DataPointIdInput!
    incomes: [String]
    expenses: [String]
    statistics: StatisticsInput
    rates: RatesInput
  }

  type Query {
    getDataPointByAccount(account: String!): [DataPoint]
    getDataPointById(id: DataPointIdInput!): DataPoint
  }

  type Mutation {
    updateDataPoint(dataPoint: DataPointInput!): DataPoint
    createDataPoint(dataPoint: DataPointInput!): DataPoint
  }
`;

// GraphQLè§£æå™¨å®šä¹‰
const resolvers = {
  Query: {
    // æ ¹æ®è´¦æˆ·åæŸ¥è¯¢æ•°æ®ç‚¹
    async getDataPointByAccount(_, { account }) {
      try {
        const dataPoints = await DataPoint.findAll({
          where: sequelize.where(
            sequelize.cast(sequelize.col('id'), 'text'),
            {
              [sequelize.Op.like]: `%"account": "${account}"%`
            }
          )
        });
        return dataPoints;
      } catch (error) {
        console.error('æŸ¥è¯¢æ•°æ®ç‚¹æ—¶å‡ºé”™:', error);
        throw new Error('æŸ¥è¯¢æ•°æ®ç‚¹å¤±è´¥');
      }
    },

    // æ ¹æ®IDæŸ¥è¯¢ç‰¹å®šæ•°æ®ç‚¹
    async getDataPointById(_, { id }) {
      try {
        const dataPoint = await DataPoint.findOne({
          where: {
            id: id
          }
        });
        return dataPoint;
      } catch (error) {
        console.error('æ ¹æ®IDæŸ¥è¯¢æ•°æ®ç‚¹æ—¶å‡ºé”™:', error);
        throw new Error('æŸ¥è¯¢æ•°æ®ç‚¹å¤±è´¥');
      }
    }
  },

  Mutation: {
    // æ›´æ–°æ•°æ®ç‚¹ï¼ˆå¦‚æœå­˜åœ¨åˆ™æ›´æ–°ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰
    async updateDataPoint(_, { dataPoint }) {
      try {
        const [updatedDataPoint] = await DataPoint.upsert({
          id: dataPoint.id,
          incomes: dataPoint.incomes,
          expenses: dataPoint.expenses,
          statistics: dataPoint.statistics,
          rates: dataPoint.rates,
        });
        return updatedDataPoint;
      } catch (error) {
        console.error('æ›´æ–°æ•°æ®ç‚¹æ—¶å‡ºé”™:', error);
        throw new Error('æ›´æ–°æ•°æ®ç‚¹å¤±è´¥');
      }
    },

    // åˆ›å»ºæ–°çš„æ•°æ®ç‚¹
    async createDataPoint(_, { dataPoint }) {
      try {
        const newDataPoint = await DataPoint.create({
          id: dataPoint.id,
          incomes: dataPoint.incomes,
          expenses: dataPoint.expenses,
          statistics: dataPoint.statistics,
          rates: dataPoint.rates,
        });
        return newDataPoint;
      } catch (error) {
        console.error('åˆ›å»ºæ•°æ®ç‚¹æ—¶å‡ºé”™:', error);
        throw new Error('åˆ›å»ºæ•°æ®ç‚¹å¤±è´¥');
      }
    }
  },

  // å­—æ®µè§£æå™¨
  DataPoint: {
    id: (parent) => parent.id,
    incomes: (parent) => parent.incomes,
    expenses: (parent) => parent.expenses,
    statistics: (parent) => parent.statistics,
    rates: (parent) => parent.rates,
    createdAt: (parent) => parent.createdAt ? parent.createdAt.toISOString() : null,
    updatedAt: (parent) => parent.updatedAt ? parent.updatedAt.toISOString() : null,
  }
};

module.exports = { typeDefs, resolvers };
```

### 4. index.js
```javascript
const { ApolloServer } = require('@apollo/server'); // Apollo Server 4.x
const { buildSubgraphSchema } = require('@apollo/subgraph'); // Federationæ”¯æŒ
const express = require('express'); // ä½¿ç”¨ Express å¤„ç† HTTP è¯·æ±‚
const { expressMiddleware } = require('@apollo/server/express4'); // Apollo Server å’Œ Express é›†æˆ
const { typeDefs, resolvers } = require('./schema'); // å¼•å…¥ schema å’Œ resolvers
const { sequelize } = require('./db'); // æ•°æ®åº“è¿æ¥
const bodyParser = require('body-parser');

// åˆ›å»º Apollo Server å®ä¾‹ï¼Œä½¿ç”¨ Federation æ”¯æŒ
const server = new ApolloServer({
  schema: buildSubgraphSchema({
    typeDefs,
    resolvers,
  }),
});

// åˆ›å»º Express åº”ç”¨
const app = express();

// å¯åŠ¨ Apollo Serverï¼Œå¹¶ä¸ Express é›†æˆ
async function startServer() {
  try {
    // å¯åŠ¨ Apollo Server
    await server.start();
    console.log('Apollo Server å¯åŠ¨æˆåŠŸ');

    app.use(bodyParser.json({ limit: '10mb' }));

    // ä½¿ç”¨ Apollo ä¸­é—´ä»¶å¤„ç† /graphql è·¯ç”±
    app.use('/graphql', express.json(), expressMiddleware(server));

    // æµ‹è¯•æ•°æ®åº“è¿æ¥
    await sequelize.authenticate();
    console.log('æ•°æ®åº“è¿æ¥æˆåŠŸ');

    // åŒæ­¥æ•°æ®åº“æ¨¡å‹ï¼ˆå¼€å‘ç¯å¢ƒä½¿ç”¨ï¼Œç”Ÿäº§ç¯å¢ƒè¯·è°¨æ…ä½¿ç”¨ï¼‰
    await sequelize.sync({ alter: false }); // ä¸æ”¹å˜ç°æœ‰è¡¨ç»“æ„
    console.log('æ•°æ®åº“åŒæ­¥å®Œæˆ');

    // å¯åŠ¨ Express æœåŠ¡å™¨
    app.listen({ port: 4002 }, () => {
      console.log(`ğŸš€ Statistic Subgraph ready at http://localhost:4002/graphql`);
    });

  } catch (error) {
    console.error('å¯åŠ¨æœåŠ¡æ—¶å‡ºé”™:', error);
    process.exit(1);
  }
}

// å¯åŠ¨æœåŠ¡
startServer();
```

### 5. æ›´æ–°ç½‘å…³æœåŠ¡ (gateway-service/index.js)
æ‚¨éœ€è¦å°†æ–°çš„ç»Ÿè®¡æœåŠ¡æ·»åŠ åˆ°ç½‘å…³çš„æœåŠ¡åˆ—è¡¨ä¸­ï¼š

```javascript
const { ApolloServer } = require('@apollo/server');
const { ApolloGateway } = require('@apollo/gateway');

const express = require('express');
const { expressMiddleware } = require('@apollo/server/express4');

const gateway = new ApolloGateway({
  serviceList: [
    { name: 'account-service', url: 'http://localhost:4001/graphql' },
    { name: 'statistic-service', url: 'http://localhost:4002/graphql' }, // æ–°å¢çš„ç»Ÿè®¡æœåŠ¡
  ],
});

const server = new ApolloServer({
  gateway,
  subscriptions: false,
  introspection: true,
});

async function startServer() {
  // å¯åŠ¨ Apollo Server
  await server.start();

  // åˆ›å»º Express åº”ç”¨
  const app = express();
  app.use(express.json());

  // å°† Apollo Server ä¸­é—´ä»¶æ·»åŠ åˆ° Express åº”ç”¨
  app.use('/graphql', expressMiddleware(server));

  // å¯åŠ¨ HTTP æœåŠ¡å™¨
  app.listen(4000, () => {
    console.log(`ğŸš€ Gateway ready at http://localhost:4000/graphql`);
  });
}

// å¯åŠ¨æœåŠ¡
startServer();
```

## ä½¿ç”¨è¯´æ˜

1. **å®‰è£…ä¾èµ–**ï¼šåœ¨ `graphql-statistic-service` ç›®å½•ä¸‹è¿è¡Œ `npm install`

2. **å¯åŠ¨æœåŠ¡**ï¼šè¿è¡Œ `npm start` å¯åŠ¨ç»Ÿè®¡æœåŠ¡ï¼ˆç«¯å£4002ï¼‰

3. **GraphQLæŸ¥è¯¢ç¤ºä¾‹**ï¼š
   ```graphql
   # æ ¹æ®è´¦æˆ·æŸ¥è¯¢æ•°æ®ç‚¹
   query {
     getDataPointByAccount(account: "Alice") {
       id {
         date
         account
       }
       incomes
       expenses
       statistics {
         SAVING_AMOUNT
         INCOMES_AMOUNT 
         EXPENSES_AMOUNT
       }
       rates {
         USD
         EUR
         RUB
       }
     }
   }

   # æ›´æ–°æ•°æ®ç‚¹
   mutation {
     updateDataPoint(dataPoint: {
       id: {
         date: "2024-10-23T12:00:00Z"
         account: "Alice"
       }
       incomes: ["Salary:5000", "Bonus:2000"]
       expenses: ["Rent:1500", "Groceries:500"]
       statistics: {
         SAVING_AMOUNT: 3000
         INCOMES_AMOUNT: 7000
         EXPENSES_AMOUNT: 2000
       }
       rates: {
         USD: 1.0
         EUR: 0.85
         RUB: 75.0
       }
     }) {
       id {
         date
         account
       }
       statistics {
         SAVING_AMOUNT
       }
     }
   }
   ```

è¿™ä¸ªæ–°çš„æœåŠ¡å°†å®Œç¾é›†æˆåˆ°æ‚¨ç°æœ‰çš„Apolloè”åˆç½‘å…³æ¶æ„ä¸­ï¼Œæä¾›ç»Ÿè®¡æ•°æ®çš„æŸ¥è¯¢å’Œæ›´æ–°åŠŸèƒ½ã€‚